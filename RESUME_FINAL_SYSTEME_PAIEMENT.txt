üìã R√âSUM√â FINAL - SYST√àME DE PAIEMENT ET CONTRAT KAZIPRO
==========================================================

## ‚úÖ D√âCISIONS VALID√âES

### 1. FRAIS DE D√âPLACEMENT
- ‚úÖ OPTIONNELS (d√©sactiv√©s par d√©faut)
- ‚úÖ Prestataire choisit d'activer ou non
- ‚úÖ 4 modes: fixe, par km, par zone, gratuit
- ‚úÖ Si d√©sactiv√©s: pas de ligne dans le devis

### 2. MOMENT DU PAIEMENT
- ‚úÖ APR√àS signature du contrat (les deux parties)
- ‚úÖ Syst√®me Acompte + Solde (30/70 par d√©faut)
- ‚úÖ Acompte: pay√© apr√®s signature, avant travaux
- ‚úÖ Solde: pay√© apr√®s validation des travaux
- ‚úÖ Auto-validation apr√®s 7 jours si pas de r√©ponse
- ‚úÖ Syst√®me de litiges int√©gr√©

### 3. COMMISSION KAZIPRO
- ‚úÖ SYST√àME FLEXIBLE ET PARAM√âTRABLE
- ‚úÖ Commission HYBRIDE:
  - Main d'≈ìuvre: 5%
  - Mat√©riel: 2% (r√©duite)
  - D√©placement: 5%
- ‚úÖ Configuration √† 3 niveaux:
  1. Admin (global)
  2. Prestataire (individuel)
  3. Par devis (optionnel)

### 4. FLEXIBILIT√â DU SYST√àME
- ‚úÖ Prestataire peut ACTIVER/D√âSACTIVER paiement via KaziPro
- ‚úÖ Prestataire peut CHOISIR quels √©l√©ments passent par KaziPro
- ‚úÖ Paiement mixte possible (KaziPro + Direct)
- ‚úÖ Paiement 100% direct possible (0% commission)

## üéØ FLUX COMPLET RECOMMAND√â

```
1. CLIENT: Cr√©e une demande

2. PRESTATAIRE: Cr√©e un devis
   - Travaux: 60,000 FC
   - Mat√©riel: 30,000 FC (optionnel via KaziPro)
   - D√©placement: 10,000 FC (optionnel, calcul√© auto)
   - Total: 100,000 FC

3. CLIENT: Accepte le devis

4. SYST√àME: G√©n√®re contrat automatiquement
   - Contrat PDF avec toutes les conditions
   - Num√©ro: CONT-2026-0001

5. CLIENT: Signe le contrat √©lectroniquement

6. PRESTATAIRE: Signe le contrat aussi

7. CLIENT: Paie l'ACOMPTE (30%)
   - Via KaziPro: 70,000 FC (travaux + d√©placement)
     Commission: 3,500 FC
     Prestataire re√ßoit: 66,500 FC
   - Direct: 30,000 FC (mat√©riel)
     Commission: 0 FC
   
8. SYST√àME: G√©n√®re re√ßu + Cr√©e mission

9. PRESTATAIRE: Effectue les travaux

10. PRESTATAIRE: Marque travaux comme termin√©s

11. CLIENT: Valide les travaux (7 jours max)

12. CLIENT: Paie le SOLDE (70%)
    - Via KaziPro ou Direct selon config

13. SYST√àME: Mission compl√©t√©e
    - Fonds lib√©r√©s au prestataire
    - Les deux peuvent laisser un avis
```

## üóÑÔ∏è STRUCTURE DE BASE DE DONN√âES

### NOUVELLES TABLES (6)

1. **configuration_paiement_globale**
   - Mode: desactive, optionnel, obligatoire
   - Commissions par d√©faut
   - Permissions

2. **configuration_paiement_prestataire**
   - paiement_via_kazipro (BOOLEAN)
   - main_oeuvre_via_kazipro (BOOLEAN)
   - materiel_via_kazipro (BOOLEAN)
   - deplacement_via_kazipro (BOOLEAN)
   - Commissions personnalis√©es

3. **frais_deplacement_config**
   - actif (BOOLEAN)
   - mode_calcul (fixe, par_km, par_zone, gratuit)
   - Tarifs et limites

4. **conditions_paiement_templates**
   - Templates r√©utilisables
   - Acompte/solde configurables

5. **contrats**
   - Contrat PDF + HTML
   - Signatures √©lectroniques
   - Statuts

6. **paiements** (nouvelle version)
   - Type: acompte, solde, complet
   - Montants s√©par√©s (travaux, mat√©riel, d√©placement)
   - Commissions
   - M√©thodes: M-Pesa, Airtel, Carte

### TABLES √Ä MODIFIER (1)

1. **devis_pro**
   - Ajouter: montant_travaux_ht
   - Ajouter: montant_materiel_ht
   - Ajouter: frais_deplacement
   - Ajouter: distance_km
   - Ajouter: configuration_paiement (JSONB)
   - Ajouter: conditions_paiement_id
   - Modifier: statuts (ajouter accepte_en_attente_contrat)

## üîß FONCTIONS SQL N√âCESSAIRES

1. **calculate_frais_deplacement(prestataire_id, distance_km)**
   - Retourne montant selon config
   - Retourne 0 si d√©sactiv√©

2. **calculate_commission_kazipro(devis_id)**
   - Calcule commission selon config prestataire
   - Retourne montants d√©taill√©s

3. **calculate_devis_montants(devis_id)** (modifier)
   - Calcule travaux, mat√©riel, d√©placement s√©par√©ment
   - Applique TVA
   - Calcule commission

4. **generate_contrat_numero()**
   - CONT-2026-0001, CONT-2026-0002, etc.

5. **generate_paiement_numero()**
   - PAY-2026-0001, PAY-2026-0002, etc.

## üì¶ STORAGE BUCKETS (3)

1. **contrats** (private)
2. **signatures** (private)
3. **recus** (private)

## üìä REQUIREMENTS CR√â√âS

Total: 24 requirements avec acceptance criteria d√©taill√©s

1-2: Frais de d√©placement (optionnels)
3-5: G√©n√©ration contrat et signatures
6-8: Paiements (complet, acompte+solde)
9-11: Int√©grations (M-Pesa, Airtel, notifications)
12-15: Historique, √©checs, s√©curit√©, missions
16-18: Validation, litiges, configuration d√©lais
19-24: Syst√®me flexible (config globale, prestataire, commissions)

## üöÄ STRAT√âGIE DE D√âPLOIEMENT

### PHASE 1: Lancement (Mois 1-3)
- Mode: Optionnel
- Commission: 0% (promotion)
- Objectif: Attirer prestataires

### PHASE 2: Test (Mois 4-6)
- Mode: Optionnel
- Commission: 3% (r√©duite)
- Objectif: Tester syst√®me

### PHASE 3: Croissance (Mois 7-12)
- Mode: Optionnel
- Commission: 5% service, 2% mat√©riel
- Objectif: G√©n√©rer revenus

### PHASE 4: Maturit√© (Apr√®s 1 an)
- Mode: Obligatoire (nouveaux)
- Commission: 5-8% selon volume
- Objectif: Mod√®le stable

## üìã ORDRE D'IMPL√âMENTATION

### PHASE 1: Base de donn√©es (2-3 jours)
1. Cr√©er tables de configuration
2. Cr√©er table frais_deplacement_config
3. Cr√©er table conditions_paiement_templates
4. Cr√©er table contrats
5. Cr√©er nouvelle table paiements
6. Modifier table devis_pro
7. Cr√©er fonctions SQL
8. Cr√©er storage buckets + policies

### PHASE 2: Configuration (2-3 jours)
1. Interface admin (config globale)
2. Interface prestataire (config individuelle)
3. Interface frais de d√©placement
4. Interface templates paiement
5. Tests

### PHASE 3: Devis am√©lior√©s (2-3 jours)
1. Calcul automatique frais d√©placement
2. Calcul commissions selon config
3. Affichage s√©par√© travaux/mat√©riel/d√©placement
4. S√©lection template paiement
5. Tests

### PHASE 4: Contrats (3-4 jours)
1. G√©n√©ration automatique contrat PDF
2. Interface signature √©lectronique
3. Stockage et t√©l√©chargement
4. Trigger sur acceptation devis
5. Tests

### PHASE 5: Paiements (4-5 jours)
1. Interface paiement (acompte/solde)
2. Paiement mixte (KaziPro + Direct)
3. Int√©gration M-Pesa
4. Int√©gration Airtel Money
5. G√©n√©ration re√ßus
6. Webhooks confirmation
7. Tests

### PHASE 6: Validation & Litiges (2-3 jours)
1. Interface validation travaux
2. Auto-validation apr√®s d√©lai
3. Syst√®me de litiges
4. Interface admin litiges
5. Tests

### PHASE 7: Tests & D√©ploiement (2-3 jours)
1. Tests d'int√©gration
2. Tests utilisateurs
3. Documentation
4. D√©ploiement progressif

**TOTAL: 3-4 semaines**

## üí° POINTS CL√âS √Ä RETENIR

### Flexibilit√©
‚úÖ Syst√®me param√©trable √† tous les niveaux
‚úÖ Pas de blocage au lancement
‚úÖ √âvolutif selon le march√©

### S√©curit√©
‚úÖ Contrat sign√© avant paiement
‚úÖ Acompte + Solde = protection mutuelle
‚úÖ Auto-validation = protection prestataire
‚úÖ Syst√®me de litiges = recours

### Transparence
‚úÖ Commissions claires
‚úÖ S√©paration travaux/mat√©riel/d√©placement
‚úÖ Re√ßus automatiques
‚úÖ Historique complet

### √âconomie
‚úÖ Commission hybride √©quitable
‚úÖ D√©ploiement progressif (0% ‚Üí 5%)
‚úÖ N√©gociation possible
‚úÖ Comp√©titif vs march√©

## üìÇ DOCUMENTS CR√â√âS

1. ‚úÖ requirements.md (24 requirements)
2. ‚úÖ ANALYSE_FLUX_PAIEMENT.md (500+ lignes)
3. ‚úÖ QUESTIONS_CLIENT.md (50+ questions)
4. ‚úÖ DIAGRAMME_FLUX.txt (flux visuels)
5. ‚úÖ ANALYSE_STRUCTURE_ACTUELLE.md (structure DB)
6. ‚úÖ SYSTEME_SECURISE_DEUX_PARTIES.md (s√©curit√©)
7. ‚úÖ SYSTEME_PAIEMENT_FLEXIBLE.md (flexibilit√©)
8. ‚úÖ DECISION_FINALE_PAIEMENT.txt (d√©cision)
9. ‚úÖ RESUME_FINAL_SYSTEME_PAIEMENT.txt (ce fichier)

## üéØ PROCHAINES √âTAPES

1. ‚úÖ Valider ce r√©sum√©
2. Cr√©er design.md avec:
   - Architecture technique compl√®te
   - Sch√©mas SQL d√©taill√©s
   - Diagrammes de flux
   - Sp√©cifications APIs
   - Maquettes interfaces
3. Cr√©er tasks.md avec:
   - Liste d√©taill√©e des t√¢ches
   - Ordre d'ex√©cution
   - Estimation temps
   - D√©pendances
4. Commencer l'impl√©mentation

## ‚úÖ VALIDATION FINALE

Syst√®me con√ßu pour:
- ‚úÖ S√©curiser les deux parties (acompte + solde)
- ‚úÖ Frais de d√©placement optionnels
- ‚úÖ Commission flexible et param√©trable
- ‚úÖ Lancement sans friction (0% possible)
- ‚úÖ √âvolution progressive vers mod√®le √©conomique viable
- ‚úÖ Transparence totale
- ‚úÖ Comp√©titif sur le march√©

**PR√äT POUR LE DESIGN ET L'IMPL√âMENTATION!** üöÄ

