â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”„ FLUX COMPLET DU SYSTÃˆME DE PAIEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Date: 27 janvier 2025
Version: 1.0

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ VUE D'ENSEMBLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Le systÃ¨me de paiement KaziPro suit un processus en 6 Ã©tapes:

1. Acceptation du devis
2. Signature du contrat
3. Paiement de l'acompte
4. RÃ©alisation de la mission
5. Paiement du solde
6. ClÃ´ture et Ã©valuation

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ Ã‰TAPE 1: ACCEPTATION DU DEVIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Route: /dashboard/client/devis/:devisId/accepter

Composant: AccepterDevisPage.tsx
Composant: DevisDetailCard.tsx

Actions:
âœ“ Client consulte le devis dÃ©taillÃ©
âœ“ Voit les montants (HT, TVA, TTC)
âœ“ Voit les conditions de paiement (acompte/solde)
âœ“ Lit les alertes de sÃ©curitÃ©
âœ“ Accepte les conditions gÃ©nÃ©rales
âœ“ Accepte les conditions de paiement
âœ“ Clique "Accepter et continuer"

Base de donnÃ©es:
â†’ UPDATE devis_pro SET statut = 'accepte'

Redirection:
â†’ /dashboard/client/contrat/:devisId

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ Ã‰TAPE 2: SIGNATURE DU CONTRAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Route: /dashboard/client/contrat/:devisId

Composant: SignerContratPage.tsx
Trigger SQL: create_trigger_contrat_auto.sql

Actions:
âœ“ Trigger SQL gÃ©nÃ¨re automatiquement le contrat
âœ“ Client lit le contrat HTML
âœ“ Client dessine sa signature sur le canvas
âœ“ Signature uploadÃ©e dans storage (bucket 'signatures')
âœ“ Clique "Signer et continuer"

Base de donnÃ©es:
â†’ INSERT INTO contrats (gÃ©nÃ©rÃ© par trigger)
â†’ UPDATE contrats SET 
    signature_client_url = '...',
    date_signature_client = NOW(),
    statut = 'signe_client'

Redirection:
â†’ /dashboard/client/paiement/:contratId/acompte

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ Ã‰TAPE 3: PAIEMENT DE L'ACOMPTE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Route: /dashboard/client/paiement/:contratId/acompte

Composant: PaiementAcomptePage.tsx

Actions:
âœ“ Client voit le rÃ©sumÃ© (prestataire, montant, acompte)
âœ“ Choisit la mÃ©thode de paiement (M-Pesa, Airtel, Orange)
âœ“ Entre son numÃ©ro de tÃ©lÃ©phone
âœ“ Clique "Payer"
âœ“ SystÃ¨me gÃ©nÃ¨re le numÃ©ro de paiement
âœ“ SystÃ¨me crÃ©e l'enregistrement de paiement
âœ“ Simulation du paiement (2 secondes)
âœ“ SystÃ¨me valide le paiement
âœ“ SystÃ¨me crÃ©e la mission

Base de donnÃ©es:
â†’ RPC generate_paiement_numero()
â†’ INSERT INTO paiements (
    numero, contrat_id, client_id, prestataire_id,
    type_paiement = 'acompte',
    montant, methode_paiement,
    statut = 'en_cours'
  )
â†’ UPDATE paiements SET 
    statut = 'valide',
    date_paiement = NOW(),
    reference_externe = '...'
â†’ INSERT INTO missions (
    demande_id, devis_id, contrat_id,
    client_id, prestataire_id,
    status = 'en_cours',
    start_date = NOW()
  )

Redirection:
â†’ /dashboard/client/paiement/:paiementId/confirmation

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ Ã‰TAPE 3.5: CONFIRMATION DU PAIEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Route: /dashboard/client/paiement/:paiementId/confirmation

Composant: PaiementConfirmationPage.tsx

Actions:
âœ“ Client voit la confirmation de succÃ¨s
âœ“ Voit les dÃ©tails du paiement
âœ“ Voit les prochaines Ã©tapes
âœ“ Peut tÃ©lÃ©charger le reÃ§u (prÃ©parÃ©)
âœ“ Retourne au dashboard

Base de donnÃ©es:
â†’ SELECT paiements (lecture seule)

Redirection:
â†’ /dashboard/client (bouton manuel)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ Ã‰TAPE 4: RÃ‰ALISATION DE LA MISSION (Ã€ IMPLÃ‰MENTER)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Route: /dashboard/client/missions/:missionId (Ã  crÃ©er)
Route: /dashboard/prestataire/missions/:missionId (existe)

Actions Ã  implÃ©menter:
â–¡ Prestataire upload des photos de progression
â–¡ Client et prestataire communiquent
â–¡ Prestataire met Ã  jour l'avancement
â–¡ Client valide les Ã©tapes
â–¡ Prestataire demande la validation finale
â–¡ Client valide la fin des travaux

Base de donnÃ©es:
â†’ UPDATE missions SET status = 'en_validation'
â†’ INSERT INTO messages (communication)
â†’ INSERT INTO photos_mission (preuves)

Redirection:
â†’ /dashboard/client/paiement/:contratId/solde

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ Ã‰TAPE 5: PAIEMENT DU SOLDE (Ã€ IMPLÃ‰MENTER)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Route: /dashboard/client/paiement/:contratId/solde (Ã  crÃ©er)

Composant: PaiementSoldePage.tsx (Ã  crÃ©er)

Actions Ã  implÃ©menter:
â–¡ Client voit le rÃ©sumÃ© du solde
â–¡ Choisit la mÃ©thode de paiement
â–¡ Entre son numÃ©ro de tÃ©lÃ©phone
â–¡ Clique "Payer le solde"
â–¡ SystÃ¨me crÃ©e le paiement
â–¡ SystÃ¨me valide le paiement
â–¡ SystÃ¨me libÃ¨re les fonds au prestataire
â–¡ SystÃ¨me clÃ´ture la mission

Base de donnÃ©es:
â†’ INSERT INTO paiements (type_paiement = 'solde')
â†’ UPDATE paiements SET statut = 'valide'
â†’ UPDATE missions SET status = 'terminee'
â†’ LibÃ©ration des fonds (via API externe)

Redirection:
â†’ /dashboard/client/paiement/:paiementId/confirmation

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ Ã‰TAPE 6: CLÃ”TURE ET Ã‰VALUATION (Ã€ IMPLÃ‰MENTER)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Route: /dashboard/client/avis/nouveau/:missionId (Ã  crÃ©er)

Actions Ã  implÃ©menter:
â–¡ Client laisse un avis
â–¡ Client note le prestataire (1-5 Ã©toiles)
â–¡ Client Ã©crit un commentaire
â–¡ SystÃ¨me met Ã  jour la note du prestataire
â–¡ SystÃ¨me archive la mission

Base de donnÃ©es:
â†’ INSERT INTO avis (
    mission_id, client_id, prestataire_id,
    note, commentaire
  )
â†’ UPDATE prestataires SET 
    note_moyenne = AVG(avis.note),
    nombre_avis = COUNT(avis)
â†’ UPDATE missions SET status = 'archivee'

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”€ FLUX ALTERNATIF: LITIGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DÃ©clenchement: Ã€ tout moment aprÃ¨s le paiement de l'acompte

Route: /dashboard/client/litiges/nouveau/:missionId (Ã  crÃ©er)

Actions Ã  implÃ©menter:
â–¡ Client ou prestataire dÃ©clare un litige
â–¡ Remplit le formulaire (motif, description)
â–¡ Upload des preuves (photos, documents)
â–¡ SystÃ¨me notifie l'admin
â–¡ Admin examine le litige
â–¡ Admin propose une solution
â–¡ Parties acceptent ou refusent
â–¡ SystÃ¨me applique la dÃ©cision (remboursement, etc.)

Base de donnÃ©es:
â†’ INSERT INTO litiges (
    mission_id, declarant_type, motif,
    description, statut = 'ouvert'
  )
â†’ INSERT INTO preuves_litige (photos, documents)
â†’ UPDATE litiges SET statut = 'en_mediation'
â†’ UPDATE litiges SET statut = 'resolu'
â†’ Remboursement si nÃ©cessaire

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š STATUTS DES ENTITÃ‰S
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DEVIS:
- brouillon â†’ en_attente â†’ accepte â†’ refuse

CONTRAT:
- genere â†’ signe_client â†’ signe_prestataire â†’ actif

PAIEMENT:
- en_cours â†’ valide â†’ echoue â†’ rembourse

MISSION:
- en_cours â†’ en_validation â†’ terminee â†’ archivee

LITIGE:
- ouvert â†’ en_mediation â†’ resolu â†’ clos

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” SÃ‰CURITÃ‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Acompte:
âœ“ BloquÃ© sur le compte KaziPro
âœ“ LibÃ©rÃ© au prestataire au dÃ©but des travaux
âœ“ Remboursable en cas de litige

Solde:
âœ“ PayÃ© aprÃ¨s validation des travaux
âœ“ LibÃ©rÃ© immÃ©diatement au prestataire
âœ“ Non remboursable (sauf litige grave)

RLS Policies:
âœ“ Client voit ses paiements
âœ“ Prestataire voit ses paiements
âœ“ Admin voit tous les paiements
âœ“ Webhooks utilisent le service role

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“± NOTIFICATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ã€ implÃ©menter:

Email:
â–¡ Confirmation d'acceptation du devis
â–¡ Contrat signÃ©
â–¡ Paiement reÃ§u (acompte)
â–¡ Mission dÃ©marrÃ©e
â–¡ Validation demandÃ©e
â–¡ Paiement reÃ§u (solde)
â–¡ Mission terminÃ©e
â–¡ Litige dÃ©clarÃ©

SMS:
â–¡ Confirmation de paiement
â–¡ Rappel de validation
â–¡ Alerte de litige

Push (app mobile):
â–¡ Nouveau message
â–¡ Mise Ã  jour de mission
â–¡ Paiement reÃ§u

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ RÃ‰SUMÃ‰ DES ROUTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

IMPLÃ‰MENTÃ‰ES:
âœ“ /dashboard/client/devis/:devisId/accepter
âœ“ /dashboard/client/contrat/:devisId
âœ“ /dashboard/client/paiement/:contratId/acompte
âœ“ /dashboard/client/paiement/:paiementId/confirmation

Ã€ CRÃ‰ER:
â–¡ /dashboard/client/missions/:missionId
â–¡ /dashboard/client/paiement/:contratId/solde
â–¡ /dashboard/client/avis/nouveau/:missionId
â–¡ /dashboard/client/litiges/nouveau/:missionId

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ˆ PROGRESSION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Phase 1: Configuration admin          âœ… 100%
Phase 2: Configuration prestataire    âœ… 100%
Phase 3: Acceptation et signature     âœ… 100%
Phase 4: Paiement acompte             âœ… 100% (simulation)
Phase 5: Suivi mission                â³ 0%
Phase 6: Paiement solde               â³ 0%
Phase 7: Ã‰valuation                   â³ 0%
Phase 8: Litiges                      â³ 0%
Phase 9: IntÃ©grations rÃ©elles         â³ 0%

TOTAL: 44% complÃ©tÃ©

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš€ PROCHAINES ACTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Tester le flux complet (acceptation â†’ signature â†’ paiement)
2. ExÃ©cuter FIX_RLS_PAIEMENTS.sql
3. ImplÃ©menter le suivi de mission
4. ImplÃ©menter le paiement du solde
5. ImplÃ©menter les Ã©valuations
6. ImplÃ©menter les litiges
7. IntÃ©grer les vraies APIs de paiement
8. ImplÃ©menter les notifications
9. GÃ©nÃ©rer les reÃ§us PDF
10. Tests utilisateurs

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
