â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ã‰TAT ACTUEL - SYSTÃˆME DE CONTRATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“… Date: 27 janvier 2026
ğŸ¯ Objectif: GÃ©nÃ©ration automatique de contrats aprÃ¨s acceptation de devis

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… CE QUI A Ã‰TÃ‰ FAIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. BOUTON "VOIR LE CONTRAT" AJOUTÃ‰ PARTOUT
   âœ… AccepterDevisPage.tsx - Affiche le bouton si devis dÃ©jÃ  acceptÃ©
   âœ… DemandeDetailPage.tsx - Bouton dans la liste des devis acceptÃ©s
   âœ… DemandesPage.tsx - Bouton dans l'onglet "Devis acceptÃ©s"
   
   Tous les boutons redirigent vers: /dashboard/client/contrat/:devisId

2. CRÃ‰ATION AUTOMATIQUE DE CONTRAT
   âœ… SignerContratPage.tsx modifiÃ© avec logique auto-crÃ©ation:
      - Utilise maybeSingle() au lieu de single() (Ã©vite erreur si pas de contrat)
      - Si contrat n'existe pas, appelle createContrat()
      - GÃ©nÃ¨re: numÃ©ro, contenu HTML, conditions de paiement (30/70)
      - InsÃ¨re dans la table contrats avec statut 'genere'

3. POLLING APRÃˆS ACCEPTATION
   âœ… AccepterDevisPage.tsx attend jusqu'Ã  5 secondes:
      - VÃ©rifie toutes les 500ms si le contrat est crÃ©Ã©
      - Redirige vers la page de signature mÃªme si pas encore crÃ©Ã©
      - La page de signature crÃ©era le contrat si nÃ©cessaire

4. SQL TRIGGER CORRIGÃ‰
   âœ… sql/fix_trigger_contrat_simple.sql:
      - SupprimÃ© la rÃ©fÃ©rence Ã  date_generation (colonne inexistante)
      - Utilise created_at automatiquement
      - Trigger se dÃ©clenche quand statut passe Ã  'accepte'

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ STRUCTURE DE LA TABLE CONTRATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Colonnes confirmÃ©es:
- id (uuid)
- numero (text)
- devis_id (uuid)
- client_id (uuid)
- prestataire_id (uuid)
- contenu_html (text)
- contrat_pdf_url (text)
- signature_client_url (text)
- signature_prestataire_url (text)
- date_signature_client (timestamp)
- date_signature_prestataire (timestamp)
- statut (text)
- conditions_paiement (jsonb)
- metadata (jsonb)
- created_at (timestamp) â† UtilisÃ© au lieu de date_generation
- updated_at (timestamp)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§ª COMMENT TESTER LE FLUX COMPLET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OPTION A: TESTER AVEC TRIGGER AUTOMATIQUE
------------------------------------------
1. ExÃ©cuter le SQL trigger:
   - Ouvrir Supabase SQL Editor
   - Copier/coller le contenu de: sql/fix_trigger_contrat_simple.sql
   - ExÃ©cuter

2. Accepter un nouveau devis:
   - Aller sur une demande avec un devis en attente
   - Cliquer "Accepter le devis"
   - Le trigger devrait crÃ©er le contrat automatiquement
   - Vous serez redirigÃ© vers la page de signature

3. VÃ©rifier:
   - Le contrat devrait Ãªtre crÃ©Ã© instantanÃ©ment
   - La page de signature devrait s'afficher sans erreur


OPTION B: TESTER SANS TRIGGER (CRÃ‰ATION ON-DEMAND)
---------------------------------------------------
1. NE PAS exÃ©cuter le trigger SQL

2. Accepter un devis:
   - Aller sur une demande avec un devis en attente
   - Cliquer "Accepter le devis"
   - Vous serez redirigÃ© vers la page de signature

3. Le contrat sera crÃ©Ã© automatiquement:
   - SignerContratPage dÃ©tecte qu'il n'existe pas
   - Appelle createContrat() automatiquement
   - Affiche le contrat gÃ©nÃ©rÃ©
   - Vous pouvez signer immÃ©diatement


OPTION C: TESTER AVEC DEVIS DÃ‰JÃ€ ACCEPTÃ‰
-----------------------------------------
1. Aller sur une demande avec un devis dÃ©jÃ  acceptÃ©
   (par exemple: devis ID e68ca997-ed77-4b0e-8ab8-e970ed989a78)

2. Cliquer sur "Voir le contrat"

3. Le contrat sera crÃ©Ã© si nÃ©cessaire:
   - Si pas de contrat â†’ crÃ©ation automatique
   - Si contrat existe â†’ affichage direct
   - Vous pouvez signer

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ FLUX COMPLET ATTENDU
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. CLIENT ACCEPTE LE DEVIS
   â””â”€> Statut devis passe Ã  'accepte'
   â””â”€> Date d'acceptation enregistrÃ©e

2. CRÃ‰ATION DU CONTRAT (2 mÃ©thodes possibles)
   A) Via trigger SQL (si installÃ©):
      â””â”€> Contrat crÃ©Ã© automatiquement en base
   
   B) Via page de signature (toujours fonctionnel):
      â””â”€> Contrat crÃ©Ã© Ã  la demande si inexistant

3. AFFICHAGE PAGE SIGNATURE
   â””â”€> Contrat chargÃ© ou crÃ©Ã©
   â””â”€> Contenu HTML affichÃ©
   â””â”€> Zone de signature disponible

4. CLIENT SIGNE
   â””â”€> Signature uploadÃ©e dans bucket 'signatures'
   â””â”€> URL de signature enregistrÃ©e
   â””â”€> Statut contrat â†’ 'signe_client'
   â””â”€> Redirection vers paiement acompte

5. PAIEMENT ACOMPTE
   â””â”€> Client paie 30% du montant
   â””â”€> Mission peut commencer

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ POINTS D'ATTENTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. RLS POLICIES
   - VÃ©rifier que le client peut lire/crÃ©er des contrats
   - VÃ©rifier que le bucket 'signatures' existe et est accessible

2. BUCKET SIGNATURES
   - Doit exister dans Supabase Storage
   - Doit avoir les bonnes policies RLS
   - Script disponible: sql/create_storage_signatures.sql

3. TABLES DEVIS
   - Utiliser 'devis_pro' (pas 'devis')
   - Colonne 'statut' (pas 'status')
   - Items dans 'devis_pro_items'

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ FICHIERS IMPORTANTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PAGES MODIFIÃ‰ES:
- src/pages/dashboard/client/SignerContratPage.tsx (auto-crÃ©ation)
- src/pages/dashboard/client/AccepterDevisPage.tsx (polling + bouton)
- src/pages/dashboard/client/DemandeDetailPage.tsx (bouton)
- src/pages/dashboard/client/DemandesPage.tsx (bouton)

SQL SCRIPTS:
- sql/fix_trigger_contrat_simple.sql (trigger auto-crÃ©ation) âœ… CORRIGÃ‰
- sql/create_storage_signatures.sql (bucket signatures)
- sql/test_trigger_contrat.sql (tester le trigger)

DOCUMENTATION:
- AMELIORATION_ACCEPTATION_DEVIS.txt
- FIX_BOUTON_VOIR_CONTRAT.txt
- SOLUTION_COMPLETE_FLUX_PAIEMENT.txt

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš€ PROCHAINES Ã‰TAPES RECOMMANDÃ‰ES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. TESTER LE FLUX SANS TRIGGER
   - Plus simple, pas besoin d'exÃ©cuter SQL
   - CrÃ©ation on-demand fonctionne dÃ©jÃ 
   - Cliquer "Voir le contrat" sur un devis acceptÃ©

2. SI Ã‡A FONCTIONNE, INSTALLER LE TRIGGER (OPTIONNEL)
   - ExÃ©cuter sql/fix_trigger_contrat_simple.sql
   - Permet crÃ©ation automatique instantanÃ©e
   - AmÃ©liore l'expÃ©rience utilisateur

3. VÃ‰RIFIER LE BUCKET SIGNATURES
   - Si erreur lors de la signature
   - ExÃ©cuter sql/create_storage_signatures.sql

4. CONTINUER VERS LE PAIEMENT
   - Une fois le contrat signÃ©
   - Tester le paiement de l'acompte
   - VÃ©rifier le flux complet

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¡ RÃ‰SUMÃ‰ SIMPLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Le systÃ¨me est PRÃŠT Ã  fonctionner
âœ… CrÃ©ation automatique de contrat implÃ©mentÃ©e
âœ… Boutons "Voir le contrat" ajoutÃ©s partout
âœ… Pas besoin d'exÃ©cuter de SQL pour tester

ğŸ‘‰ TESTEZ MAINTENANT:
   1. Trouvez un devis acceptÃ©
   2. Cliquez "Voir le contrat"
   3. Le contrat sera crÃ©Ã© automatiquement
   4. Signez-le
   5. Continuez vers le paiement

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
