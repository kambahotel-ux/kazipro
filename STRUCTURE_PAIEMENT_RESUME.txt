ğŸ“Š RÃ‰SUMÃ‰ - STRUCTURE POUR SYSTÃˆME DE PAIEMENT & CONTRAT
==========================================================

ğŸ¯ TON BESOIN CLARIFIÃ‰
----------------------
âœ… Les frais de dÃ©placement sont OPTIONNELS
âœ… Le prestataire dÃ©cide s'il veut les activer ou non
âœ… Par dÃ©faut: DÃ‰SACTIVÃ‰S pour les nouveaux prestataires
âœ… Si dÃ©sactivÃ©s: pas de ligne de frais dans le devis

ğŸ“‚ STRUCTURE ACTUELLE ANALYSÃ‰E
------------------------------

TABLES EXISTANTES:
1. âœ… devis_pro - Table principale des devis
2. âœ… devis_pro_items - Lignes de devis (travaux)
3. âœ… entreprise_info - Infos entreprise du prestataire
4. âŒ paiements - Existe mais incomplÃ¨te

CE QUI MANQUE DANS devis_pro:
- Colonne: montant_travaux_ht (sÃ©parÃ©)
- Colonne: frais_deplacement (optionnel)
- Colonne: distance_km
- Colonne: conditions_paiement_id
- Nouveaux statuts: 'accepte_en_attente_contrat', 'accepte_avec_contrat'

ğŸ†• NOUVELLES TABLES Ã€ CRÃ‰ER
----------------------------

1. frais_deplacement_config
   â”œâ”€ prestataire_id (UNIQUE)
   â”œâ”€ actif (BOOLEAN) â­ IMPORTANT: false par dÃ©faut
   â”œâ”€ mode_calcul (fixe, par_km, par_zone, gratuit)
   â”œâ”€ montant_fixe
   â”œâ”€ prix_par_km
   â”œâ”€ distance_gratuite_km
   â”œâ”€ zones (JSONB)
   â”œâ”€ montant_minimum
   â””â”€ montant_maximum

2. conditions_paiement_templates
   â”œâ”€ prestataire_id
   â”œâ”€ nom (ex: "Standard", "Grands travaux")
   â”œâ”€ type_paiement (complet_avant, complet_apres, acompte_solde, echelonne)
   â”œâ”€ pourcentage_acompte
   â”œâ”€ pourcentage_solde
   â”œâ”€ echeances (JSONB)
   â””â”€ est_defaut (BOOLEAN)

3. contrats
   â”œâ”€ numero (CONT-2026-0001)
   â”œâ”€ devis_id
   â”œâ”€ client_id
   â”œâ”€ prestataire_id
   â”œâ”€ contenu_html
   â”œâ”€ contrat_pdf_url
   â”œâ”€ signature_client_url
   â”œâ”€ signature_prestataire_url
   â”œâ”€ date_signature_client
   â”œâ”€ date_signature_prestataire
   â”œâ”€ statut (genere, signe_client, signe_complet, annule)
   â””â”€ conditions_paiement (JSONB)

4. paiements (nouvelle version complÃ¨te)
   â”œâ”€ numero (PAY-2026-0001)
   â”œâ”€ contrat_id
   â”œâ”€ devis_id
   â”œâ”€ mission_id
   â”œâ”€ client_id
   â”œâ”€ prestataire_id
   â”œâ”€ type_paiement (acompte, solde, complet, echeance)
   â”œâ”€ montant_travaux â­ SÃ‰PARÃ‰
   â”œâ”€ montant_deplacement â­ SÃ‰PARÃ‰
   â”œâ”€ montant_total
   â”œâ”€ methode_paiement (mpesa, airtel_money, orange_money, carte, especes)
   â”œâ”€ statut (en_attente, en_cours, valide, echoue, rembourse)
   â”œâ”€ transaction_id
   â”œâ”€ reference_paiement
   â”œâ”€ recu_url
   â”œâ”€ date_echeance
   â”œâ”€ date_paiement
   â””â”€ date_validation

ğŸ”§ FONCTIONS Ã€ CRÃ‰ER
--------------------

1. calculate_frais_deplacement(prestataire_id, distance_km)
   â†’ Retourne le montant des frais selon la config
   â†’ Retourne 0 si config.actif = false
   â†’ Applique les limites min/max

2. calculate_devis_pro_montants(devis_id) - MODIFIER
   â†’ Calcule montant_travaux_ht (SUM des items)
   â†’ Ajoute frais_deplacement
   â†’ Calcule montant_ht = travaux + deplacement
   â†’ Calcule montant_ttc = montant_ht * (1 + tva/100)

3. generate_contrat_numero()
   â†’ GÃ©nÃ¨re CONT-2026-0001, CONT-2026-0002, etc.

4. generate_paiement_numero()
   â†’ GÃ©nÃ¨re PAY-2026-0001, PAY-2026-0002, etc.

ğŸ“¦ STORAGE BUCKETS Ã€ CRÃ‰ER
---------------------------

1. contrats (private)
   - Stocke les PDF des contrats
   - Accessible par client et prestataire concernÃ©s

2. signatures (private)
   - Stocke les images de signatures
   - Accessible uniquement par le propriÃ©taire

3. recus (private)
   - Stocke les PDF des reÃ§us
   - Accessible par client et prestataire concernÃ©s

ğŸ”„ EXEMPLE DE FLUX AVEC FRAIS OPTIONNELS
-----------------------------------------

CAS 1: Prestataire SANS frais de dÃ©placement
---------------------------------------------
1. Prestataire n'active pas les frais (actif = false)
2. CrÃ©e un devis:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ TRAVAUX                         â”‚
   â”‚ - Installation: 50,000 FC       â”‚
   â”‚ - MatÃ©riel: 30,000 FC           â”‚
   â”‚ Sous-total: 80,000 FC           â”‚
   â”‚                                 â”‚
   â”‚ TVA (16%): 12,800 FC            â”‚
   â”‚ TOTAL TTC: 92,800 FC            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   frais_deplacement = 0
   montant_travaux_ht = 80,000
   montant_ht = 80,000
   montant_ttc = 92,800

CAS 2: Prestataire AVEC frais de dÃ©placement
---------------------------------------------
1. Prestataire active les frais (actif = true)
2. Configure: 500 FC/km, 5 km gratuits
3. CrÃ©e un devis pour client Ã  12 km:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ TRAVAUX                         â”‚
   â”‚ - Installation: 50,000 FC       â”‚
   â”‚ - MatÃ©riel: 30,000 FC           â”‚
   â”‚ Sous-total: 80,000 FC           â”‚
   â”‚                                 â”‚
   â”‚ DÃ‰PLACEMENT                     â”‚
   â”‚ Distance: 12 km                 â”‚
   â”‚ Frais: 3,500 FC (7 km Ã— 500)   â”‚
   â”‚                                 â”‚
   â”‚ TOTAL HT: 83,500 FC             â”‚
   â”‚ TVA (16%): 13,360 FC            â”‚
   â”‚ TOTAL TTC: 96,860 FC            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   frais_deplacement = 3,500
   montant_travaux_ht = 80,000
   montant_ht = 83,500
   montant_ttc = 96,860

ğŸ¯ MODIFICATIONS DU requirements.md
-----------------------------------

âœ… FAIT:
1. Requirement 1: AjoutÃ© "(si applicables)" pour frais
2. Requirement 2: RenommÃ© en "Configuration des Frais de DÃ©placement (Optionnel)"
3. AjoutÃ© critÃ¨re: "activer ou dÃ©sactiver les frais"
4. AjoutÃ© critÃ¨re: "dÃ©sactivÃ©s par dÃ©faut pour nouveaux prestataires"
5. AjoutÃ© critÃ¨re: "ne pas afficher si dÃ©sactivÃ©s"

ğŸ“‹ ORDRE D'IMPLÃ‰MENTATION RECOMMANDÃ‰
-------------------------------------

PHASE 1: Base de donnÃ©es (1-2 jours)
â”œâ”€ 1.1 CrÃ©er table frais_deplacement_config
â”œâ”€ 1.2 CrÃ©er table conditions_paiement_templates
â”œâ”€ 1.3 CrÃ©er table contrats
â”œâ”€ 1.4 CrÃ©er nouvelle table paiements
â”œâ”€ 1.5 Modifier table devis_pro (ajouter colonnes)
â”œâ”€ 1.6 CrÃ©er fonctions SQL
â””â”€ 1.7 CrÃ©er storage buckets + policies

PHASE 2: Configuration prestataire (2 jours)
â”œâ”€ 2.1 Interface activation/dÃ©sactivation frais
â”œâ”€ 2.2 Interface configuration frais (modes)
â”œâ”€ 2.3 Interface templates de paiement
â””â”€ 2.4 Tests

PHASE 3: Devis amÃ©liorÃ©s (2 jours)
â”œâ”€ 3.1 Modifier crÃ©ation de devis (calcul frais)
â”œâ”€ 3.2 Affichage sÃ©parÃ© travaux/dÃ©placement
â”œâ”€ 3.3 SÃ©lection template de paiement
â””â”€ 3.4 Tests

PHASE 4: Contrats (3 jours)
â”œâ”€ 4.1 GÃ©nÃ©ration automatique de contrat
â”œâ”€ 4.2 Interface de signature Ã©lectronique
â”œâ”€ 4.3 Stockage et tÃ©lÃ©chargement
â””â”€ 4.4 Tests

PHASE 5: Paiements (4 jours)
â”œâ”€ 5.1 Interface de paiement (acompte/solde)
â”œâ”€ 5.2 IntÃ©gration M-Pesa
â”œâ”€ 5.3 IntÃ©gration Airtel Money
â”œâ”€ 5.4 GÃ©nÃ©ration de reÃ§us
â”œâ”€ 5.5 Webhooks de confirmation
â””â”€ 5.6 Tests

PHASE 6: Tests & DÃ©ploiement (2 jours)
â”œâ”€ 6.1 Tests d'intÃ©gration
â”œâ”€ 6.2 Tests utilisateurs
â””â”€ 6.3 DÃ©ploiement progressif

TOTAL: ~2-3 semaines

ğŸ’¡ POINTS CLÃ‰S Ã€ RETENIR
-------------------------

1. FRAIS OPTIONNELS â­
   âœ… DÃ©sactivÃ©s par dÃ©faut
   âœ… Prestataire choisit d'activer ou non
   âœ… Si dÃ©sactivÃ©s: pas de ligne dans le devis

2. SÃ‰PARATION CLAIRE
   âœ… montant_travaux_ht (items)
   âœ… frais_deplacement (optionnel)
   âœ… montant_ht = travaux + deplacement
   âœ… montant_ttc = montant_ht * (1 + tva/100)

3. RÃ‰TROCOMPATIBILITÃ‰
   âœ… Devis existants continuent de fonctionner
   âœ… Nouvelles colonnes avec valeurs par dÃ©faut
   âœ… Pas de migration de donnÃ©es nÃ©cessaire

4. FLEXIBILITÃ‰
   âœ… 4 modes de calcul (fixe, par_km, par_zone, gratuit)
   âœ… Templates de paiement rÃ©utilisables
   âœ… Paiements Ã©chelonnÃ©s possibles

ğŸ“‚ DOCUMENTS CRÃ‰Ã‰S
------------------

1. requirements.md (mis Ã  jour)
   â†’ User stories et acceptance criteria

2. ANALYSE_STRUCTURE_ACTUELLE.md (nouveau)
   â†’ Analyse dÃ©taillÃ©e de la structure
   â†’ Tables existantes vs nÃ©cessaires
   â†’ Modifications Ã  apporter
   â†’ Fonctions SQL complÃ¨tes

3. STRUCTURE_PAIEMENT_RESUME.txt (ce fichier)
   â†’ RÃ©sumÃ© exÃ©cutif pour toi

ğŸš€ PROCHAINES Ã‰TAPES
--------------------

MAINTENANT:
1. âœ… Lire ce rÃ©sumÃ©
2. âœ… Valider l'approche (frais optionnels)
3. âœ… Confirmer que c'est ce que tu veux

ENSUITE (aprÃ¨s ta validation):
1. CrÃ©er design.md avec:
   - Architecture technique dÃ©taillÃ©e
   - SchÃ©mas SQL complets
   - Diagrammes de flux
   - SpÃ©cifications des APIs
   
2. CrÃ©er tasks.md avec:
   - Liste des tÃ¢ches d'implÃ©mentation
   - Ordre d'exÃ©cution
   - Estimation du temps

3. Commencer l'implÃ©mentation

â“ QUESTIONS POUR TOI
---------------------

1. âœ… Confirmes-tu que les frais de dÃ©placement doivent Ãªtre OPTIONNELS?
2. Mode de calcul par dÃ©faut si activÃ©: fixe ou par km?
3. Pourcentage d'acompte standard: 30%, 40% ou 50%?
4. MÃ©thodes de paiement prioritaires: M-Pesa et Airtel Money?
5. Signature Ã©lectronique: dessinÃ©e ou code SMS?

Une fois que tu rÃ©ponds, je peux crÃ©er le design.md complet! ğŸš€

