â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GUIDE DE TEST - FLUX COMPLET DE PAIEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ PRÃ‰REQUIS SQL Ã€ EXÃ‰CUTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Installer le systÃ¨me de paiement complet:
   âœ… ExÃ©cuter: FIX_PAIEMENTS_ET_INSTALLER.sql

2. CrÃ©er le trigger de gÃ©nÃ©ration automatique de contrat:
   âœ… ExÃ©cuter: sql/create_trigger_contrat_auto.sql

3. Configurer les RLS pour les paiements:
   âœ… ExÃ©cuter: FIX_RLS_PAIEMENTS.sql

4. CrÃ©er le bucket de stockage pour les signatures:
   âœ… ExÃ©cuter dans Supabase SQL Editor:

   -- CrÃ©er le bucket signatures
   INSERT INTO storage.buckets (id, name, public)
   VALUES ('signatures', 'signatures', true)
   ON CONFLICT (id) DO NOTHING;

   -- Politique de lecture publique
   CREATE POLICY "Public read signatures"
   ON storage.objects FOR SELECT
   USING (bucket_id = 'signatures');

   -- Politique d'upload pour utilisateurs authentifiÃ©s
   CREATE POLICY "Authenticated users can upload signatures"
   ON storage.objects FOR INSERT
   WITH CHECK (
     bucket_id = 'signatures' 
     AND auth.role() = 'authenticated'
   );


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FLUX DE TEST COMPLET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ã‰TAPE 1: CRÃ‰ER UN DEVIS (CÃ´tÃ© Prestataire)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Se connecter en tant que prestataire
2. Aller dans "OpportunitÃ©s" ou "Devis"
3. CrÃ©er un nouveau devis pour un client
4. Statut du devis: "en_attente"

OU crÃ©er manuellement dans Supabase:

INSERT INTO devis_pro (
  numero,
  prestataire_id,
  client_id,
  demande_id,
  montant_ht,
  montant_ttc,
  statut,
  validite_jours
) VALUES (
  'DEV-2025-001',
  'UUID_PRESTATAIRE',
  'UUID_CLIENT',
  'UUID_DEMANDE',
  1000000,
  1000000,
  'en_attente',
  30
);


Ã‰TAPE 2: ACCEPTER LE DEVIS (CÃ´tÃ© Client)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Se connecter en tant que client
2. Aller sur le dashboard client
3. Dans "Actions en attente", cliquer sur "Accepter le devis"
   OU aller directement: /dashboard/client/devis/{devisId}/accepter

4. VÃ©rifier que la page affiche:
   âœ“ DÃ©tails du devis
   âœ“ Montant de l'acompte (30% par dÃ©faut)
   âœ“ Montant du solde (70% par dÃ©faut)
   âœ“ 2 checkboxes (conditions gÃ©nÃ©rales + conditions de paiement)

5. Cocher les 2 cases
6. Cliquer sur "Accepter et continuer"

RÃ‰SULTAT ATTENDU:
âœ“ Devis statut â†’ "accepte"
âœ“ Contrat crÃ©Ã© automatiquement (via trigger)
âœ“ Redirection vers: /dashboard/client/contrat/{devisId}


Ã‰TAPE 3: SIGNER LE CONTRAT (CÃ´tÃ© Client)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. La page de signature s'affiche automatiquement
2. VÃ©rifier que la page affiche:
   âœ“ Contenu du contrat (HTML)
   âœ“ Zone de signature (canvas blanc)
   âœ“ Bouton "Effacer"
   âœ“ Bouton "Signer et continuer vers le paiement"

3. Dessiner une signature dans le canvas
4. Cliquer sur "Signer et continuer vers le paiement"

RÃ‰SULTAT ATTENDU:
âœ“ Signature uploadÃ©e dans bucket "signatures"
âœ“ Contrat statut â†’ "signe_client"
âœ“ Champs remplis: signature_client_url, date_signature_client
âœ“ Redirection vers: /dashboard/client/paiement/{contratId}/acompte


Ã‰TAPE 4: PAYER L'ACOMPTE (CÃ´tÃ© Client)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. La page de paiement s'affiche automatiquement
2. VÃ©rifier que la page affiche:
   âœ“ DÃ©tails du contrat
   âœ“ Montant de l'acompte
   âœ“ Choix de mÃ©thode de paiement (M-Pesa, Airtel Money, Orange Money)
   âœ“ Champ numÃ©ro de tÃ©lÃ©phone

3. SÃ©lectionner une mÃ©thode de paiement
4. Entrer un numÃ©ro de tÃ©lÃ©phone (ex: 0812345678)
5. Cliquer sur "Payer l'acompte"

RÃ‰SULTAT ATTENDU (MODE SIMULATION):
âœ“ Paiement crÃ©Ã© dans table "paiements"
âœ“ Statut: "en_attente" puis "complete" (simulation)
âœ“ Mission crÃ©Ã©e automatiquement
âœ“ Redirection vers: /dashboard/client/paiement/{paiementId}/confirmation


Ã‰TAPE 5: CONFIRMATION (CÃ´tÃ© Client)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. La page de confirmation s'affiche
2. VÃ©rifier que la page affiche:
   âœ“ Message de succÃ¨s
   âœ“ DÃ©tails du paiement
   âœ“ NumÃ©ro de transaction
   âœ“ Prochaines Ã©tapes
   âœ“ Bouton "TÃ©lÃ©charger le reÃ§u"
   âœ“ Bouton "Voir ma mission"


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VÃ‰RIFICATIONS DANS SUPABASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

AprÃ¨s chaque Ã©tape, vÃ©rifier dans Supabase:

APRÃˆS ACCEPTATION DEVIS:
SELECT * FROM devis_pro WHERE id = 'UUID_DEVIS';
-- statut doit Ãªtre "accepte"
-- date_acceptation doit Ãªtre remplie

SELECT * FROM contrats WHERE devis_id = 'UUID_DEVIS';
-- Un contrat doit exister
-- statut doit Ãªtre "genere"

APRÃˆS SIGNATURE:
SELECT * FROM contrats WHERE devis_id = 'UUID_DEVIS';
-- statut doit Ãªtre "signe_client"
-- signature_client_url doit Ãªtre rempli
-- date_signature_client doit Ãªtre remplie

APRÃˆS PAIEMENT:
SELECT * FROM paiements WHERE contrat_id = 'UUID_CONTRAT';
-- Un paiement doit exister
-- type_paiement = "acompte"
-- statut = "complete"

SELECT * FROM missions WHERE contrat_id = 'UUID_CONTRAT';
-- Une mission doit exister
-- statut = "en_attente"


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROBLÃˆMES COURANTS ET SOLUTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ PROBLÃˆME: "Le contrat est en cours de gÃ©nÃ©ration"
âœ… SOLUTION: 
   - VÃ©rifier que le trigger existe: sql/create_trigger_contrat_auto.sql
   - VÃ©rifier dans Supabase que le contrat a Ã©tÃ© crÃ©Ã©
   - Si non, crÃ©er manuellement ou rÃ©exÃ©cuter le trigger

âŒ PROBLÃˆME: "Erreur lors de la signature"
âœ… SOLUTION:
   - VÃ©rifier que le bucket "signatures" existe
   - VÃ©rifier les politiques RLS du bucket
   - ExÃ©cuter le SQL ci-dessus pour crÃ©er le bucket

âŒ PROBLÃˆME: "Erreur lors du paiement"
âœ… SOLUTION:
   - VÃ©rifier que la fonction generate_paiement_numero existe
   - VÃ©rifier les RLS de la table paiements
   - ExÃ©cuter: FIX_RLS_PAIEMENTS.sql

âŒ PROBLÃˆME: Page blanche aprÃ¨s acceptation
âœ… SOLUTION:
   - Ouvrir la console (F12)
   - VÃ©rifier les erreurs JavaScript
   - VÃ©rifier que les routes existent dans App.tsx


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROUTES Ã€ VÃ‰RIFIER DANS App.tsx
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ /dashboard/client/devis/:devisId/accepter â†’ AccepterDevisPage
âœ“ /dashboard/client/contrat/:devisId â†’ SignerContratPage
âœ“ /dashboard/client/paiement/:contratId/acompte â†’ PaiementAcomptePage
âœ“ /dashboard/client/paiement/:paiementId/confirmation â†’ PaiementConfirmationPage
âœ“ /dashboard/client/missions/:missionId â†’ MissionDetailPage


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DONNÃ‰ES DE TEST RAPIDE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Pour tester rapidement, crÃ©er un devis de test:

-- 1. RÃ©cupÃ©rer les IDs
SELECT id, full_name FROM clients LIMIT 1;
SELECT id, full_name FROM prestataires WHERE statut = 'actif' LIMIT 1;
SELECT id, title FROM demandes LIMIT 1;

-- 2. CrÃ©er le devis
INSERT INTO devis_pro (
  numero,
  prestataire_id,
  client_id,
  demande_id,
  montant_ht,
  montant_ttc,
  statut,
  validite_jours,
  description
) VALUES (
  'DEV-TEST-' || EXTRACT(EPOCH FROM NOW())::TEXT,
  'PRESTATAIRE_ID_ICI',
  'CLIENT_ID_ICI',
  'DEMANDE_ID_ICI',
  500000,
  500000,
  'en_attente',
  30,
  'Devis de test pour le flux de paiement'
);

-- 3. RÃ©cupÃ©rer l'ID du devis crÃ©Ã©
SELECT id, numero FROM devis_pro ORDER BY created_at DESC LIMIT 1;

-- 4. Aller sur: /dashboard/client/devis/{ID_DU_DEVIS}/accepter


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIN DU GUIDE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
