‚úÖ DESIGN.MD CR√â√â - R√âSUM√â
==========================

## üìÇ FICHIER CR√â√â

.kiro/specs/systeme-paiement-contrat/design.md

## üìä CONTENU ACTUEL

### 1. Architecture Overview ‚úÖ
- Diagramme des composants syst√®me
- Frontend (React) ‚Üí Backend (Supabase) ‚Üí Database (PostgreSQL)
- Couches: Payment Processing, Document Generation, Storage
- Flux de donn√©es complet

### 2. Database Schema ‚úÖ

#### Nouvelles tables cr√©√©es (7):

1. **configuration_paiement_globale**
   - Tous les param√®tres modifiables par admin
   - Commissions, acompte, d√©lais, garantie
   - Permissions prestataires
   - Contraintes de validation
   - RLS policies

2. **historique_config_paiement**
   - Tra√ßabilit√© compl√®te des modifications
   - Admin, anciennes/nouvelles valeurs, raison
   - IP address, user agent
   - RLS policies

3. **configuration_paiement_prestataire**
   - Config individuelle par prestataire
   - Activation paiement via KaziPro
   - Choix des √©l√©ments
   - Commissions personnalis√©es
   - RLS policies

4. **frais_deplacement_config**
   - Activation optionnelle
   - 4 modes: fixe, par_km, par_zone, gratuit
   - Tarifs et limites
   - RLS policies

5. **conditions_paiement_templates**
   - Templates r√©utilisables
   - Types: complet_avant, complet_apres, acompte_solde, echelonne
   - Pourcentages configurables
   - RLS policies

6. **contrats**
   - Num√©ro unique (CONT-2026-0001)
   - Contenu HTML + PDF
   - Signatures √©lectroniques
   - Statuts: genere, signe_client, signe_complet, annule
   - Conditions de paiement (JSONB)
   - RLS policies

7. **paiements** (enhanced)
   - Num√©ro unique (PAY-2026-0001)
   - Montants d√©taill√©s (travaux, mat√©riel, d√©placement)
   - Commissions s√©par√©es
   - Types: acompte, solde, complet, echeance, garantie
   - M√©thodes: mpesa, airtel_money, carte, direct
   - Statuts: en_attente, en_cours, valide, echoue
   - Preuve de paiement pour paiement direct
   - RLS policies

8. **litiges**
   - Num√©ro unique (LIT-2026-0001)
   - Ouvert par client ou prestataire
   - Cat√©gories: qualite_travaux, delai, paiement, materiel
   - Preuves (JSONB)
   - R√©solution par admin
   - Montants bloqu√©s/rembours√©s
   - RLS policies

#### Tables modifi√©es (2):

1. **devis_pro**
   - Ajout: montant_travaux_ht
   - Ajout: montant_materiel_ht
   - Ajout: frais_deplacement
   - Ajout: distance_km
   - Ajout: conditions_paiement_id
   - Ajout: configuration_paiement (JSONB)
   - Nouveaux statuts: accepte_en_attente_contrat, accepte_avec_contrat

2. **missions**
   - Ajout: dates de validation
   - Ajout: validation_auto
   - Ajout: delai_validation_jours
   - Ajout: problemes_signales
   - Nouveaux statuts: terminee_en_attente_validation, validee, litige

#### Storage Buckets (4):

1. **contrats** (PDF, 10MB max)
2. **signatures** (images, 1MB max)
3. **recus** (PDF, 5MB max)
4. **preuves-paiement** (images/PDF, 5MB max)

Avec policies RLS compl√®tes pour chaque bucket.

### 3. SQL Functions ‚úÖ

1. **generate_contrat_numero()**
   - G√©n√®re CONT-2026-0001, CONT-2026-0002, etc.

2. **generate_paiement_numero()**
   - G√©n√®re PAY-2026-0001, PAY-2026-0002, etc.

3. **generate_litige_numero()**
   - G√©n√®re LIT-2026-0001, LIT-2026-0002, etc.

4. **calculate_frais_deplacement(prestataire_id, distance_km)**
   - Calcule selon config prestataire
   - Retourne 0 si d√©sactiv√©
   - Applique limites min/max

## üìã CE QUI RESTE √Ä AJOUTER AU DESIGN.MD

### 4. Business Logic (√† ajouter)
- Fonction calculate_commission_kazipro()
- Fonction calculate_devis_montants() (modifi√©e)
- Logique de validation des travaux
- Logique d'auto-validation
- Logique de cr√©ation de mission

### 5. API Specifications (√† ajouter)
- POST /api/config/paiement (admin)
- GET /api/config/paiement
- POST /api/config/prestataire (prestataire)
- POST /api/contrats/generate
- POST /api/contrats/:id/sign
- POST /api/paiements/initiate
- POST /api/paiements/webhook
- POST /api/litiges/create
- POST /api/missions/:id/validate

### 6. User Interfaces (√† ajouter)
- Interface admin (config globale)
- Interface prestataire (config individuelle)
- Interface cr√©ation devis (avec frais)
- Interface signature contrat
- Interface paiement
- Interface validation travaux
- Interface litiges

### 7. Integration Points (√† ajouter)
- M-Pesa API integration
- Airtel Money API integration
- PDF generation (jsPDF ou similaire)
- Email notifications (Supabase)
- SMS notifications (optionnel)

### 8. Security & Validation (√† ajouter)
- Validation des montants
- Validation des pourcentages
- Validation des signatures
- Protection contre fraude
- Rate limiting

### 9. Performance Considerations (√† ajouter)
- Indexation optimale
- Caching strategy
- Query optimization
- File upload optimization

## üéØ √âTAT ACTUEL

‚úÖ Architecture compl√®te
‚úÖ Sch√©mas de base de donn√©es complets
‚úÖ RLS policies compl√®tes
‚úÖ Storage buckets configur√©s
‚úÖ Fonctions SQL de base

‚è≥ √Ä compl√©ter:
- Business logic d√©taill√©e
- API specifications
- User interfaces
- Integrations
- Security details
- Performance optimization

## üìä STATISTIQUES

- Tables cr√©√©es: 8
- Tables modifi√©es: 2
- Storage buckets: 4
- Fonctions SQL: 4
- RLS policies: ~30
- Lignes de code SQL: ~800

## üöÄ PROCHAINES √âTAPES

1. Compl√©ter le design.md avec les sections restantes
2. Cr√©er tasks.md avec:
   - Liste d√©taill√©e des t√¢ches
   - Ordre d'impl√©mentation
   - Estimation du temps
   - D√©pendances
3. Commencer l'impl√©mentation

## üí° POINTS CL√âS

Le design.md contient d√©j√†:
‚úÖ Architecture compl√®te du syst√®me
‚úÖ Tous les sch√©mas de tables avec contraintes
‚úÖ Toutes les policies RLS
‚úÖ Storage buckets configur√©s
‚úÖ Fonctions SQL essentielles
‚úÖ Relations entre tables
‚úÖ Indexes pour performance

C'est une base solide pour l'impl√©mentation!

Veux-tu que je compl√®te le design.md avec les sections restantes
ou pr√©f√®res-tu passer directement au tasks.md?

